﻿@{
Layout = "_Layout";
ViewData["Title"] = "Dashboard";
}

<!-- Updated Welcome Modal -->
<div class="modal fade" id="syncModal" tabindex="-1" aria-labelledby="syncModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="syncModalLabel">
                    <i class="bi bi-cloud-arrow-down text-primary"></i> Sync Toolkit Data
                </h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="bi bi-info-circle text-primary" style="font-size: 2rem;"></i>
                </div>
                <p class="text-center">
                    <strong>Keep your data up to date!</strong>
                </p>
                <p>
                    For the best experience, import your latest forensic cases and acquisition logs from your toolkit.
                    This ensures all your data is synchronized and available for analysis.
                </p>
                <div class="alert alert-light border">
                    <small>
                        <i class="bi bi-lightbulb"></i>
                        <strong>Tip:</strong> You can always do this later from the <strong>Settings</strong> page if you're not ready now.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="syncSettingsBtn">
                    <i class="bi bi-gear"></i> Go to Settings
                </button>
                <button type="button" class="btn btn-outline-secondary" id="syncSkipBtn">
                    <i class="bi bi-clock"></i> Maybe Later
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Content -->
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>ForenSync Dashboard</h3>
        <div class="text-muted small">
            Last updated: <span id="lastUpdated">@DateTime.Now.ToString("MMM dd, yyyy HH:mm")</span>
            <button class="btn btn-sm btn-outline-secondary ms-2" id="refreshBtn">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <label class="form-label mb-0"><strong>Date Range:</strong></label>
                        </div>
                        <div class="col-auto">
                            <select class="form-select form-select-sm" id="dateRangeFilter">
                                <option value="6">Last 6 Months</option>
                                <option value="3">Last 3 Months</option>
                                <option value="12">Last 12 Months</option>
                                <option value="1">Last 30 Days</option>
                                <option value="0">All Time</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <span class="text-muted small" id="dateRangeDisplay">Showing last 6 months</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingIndicator" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading dashboard data...</span>
        </div>
        <p class="mt-2 text-muted">Loading dashboard data...</p>
    </div>

    <!-- Dashboard Content (initially hidden) -->
    <div id="dashboardContent" style="display: none;">
        <!-- Main Charts Row -->
        <div class="row my-4">
            <div class="col-md-4">
                <div class="card text-center p-3 h-100">
                    <h5>Acquisition Types</h5>
                    <canvas id="acquisitionPieChart" height="250"></canvas>
                    <div class="mt-2 small text-muted">
                        Breakdown of capture methods
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card p-3 h-100">
                    <h5>Activity Timeline</h5>
                    <p class="text-muted small mb-3">Cases and acquisitions over time</p>
                    <canvas id="activityLineChart" height="120"></canvas>
                </div>
            </div>
        </div>

        <!-- Statistics Cards Row with Quick Actions -->
        <div class="row g-3">
            <div class="col-md-3">
                <div class="card text-center p-3">
                    <i class="bi bi-folder2-open text-primary fs-1 mb-2"></i>
                    <h6>Total Cases</h6>
                    <p class="mb-0 display-6 text-primary" id="totalCases">0</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center p-3">
                    <i class="bi bi-download text-success fs-1 mb-2"></i>
                    <h6>Total Imports</h6>
                    <p class="mb-0 display-6 text-success" id="totalImports">0</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center p-3">
                    <i class="bi bi-exclamation-triangle text-warning fs-1 mb-2"></i>
                    <h6>Anomalies</h6>
                    <p class="mb-0 display-6 text-warning" id="totalAnomalies">0</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                        <h6 class="mb-0">Quick Actions</h6>
                        <span class="badge bg-primary">Shortcuts</span>
                    </div>
                    <div class="card-body p-2 d-flex align-items-center justify-content-center">
                        <div class="w-100">
                            <div class="d-grid gap-1">
                                <a href="@Url.Action("CaseViewer", "Case")" class="btn btn-outline-primary btn-sm text-start py-2">
                                    <i class="bi bi-folder2-open me-1"></i>
                                    <small>Case Management</small>
                                </a>
                                <a href="@Url.Action("MemoryPane", "Tools")" class="btn btn-outline-success btn-sm text-start py-2">
                                    <i class="bi bi-memory me-1"></i>
                                    <small>Memory Analysis</small>
                                </a>
                                <a href="@Url.Action("AnomalyViewer", "Tools")" class="btn btn-outline-warning btn-sm text-start py-2">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    <small>Anomaly Detection</small>
                                </a>
                                <a href="@Url.Action("AcquisitionHistory", "Case")" class="btn btn-outline-info btn-sm text-start py-2">
                                    <i class="bi bi-clock-history me-1"></i>
                                    <small>Acquisition History</small>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let acquisitionPieChart, activityLineChart;
        let currentDateRange = 6;

        function initializeSyncModal() {
            const modal = new bootstrap.Modal(document.getElementById('syncModal'));
            modal.show();

            document.getElementById("syncSettingsBtn").addEventListener("click", () => {
                modal.hide();
                window.location.href = '@Url.Action("Index", "Settings")';
            });

            document.getElementById("syncSkipBtn").addEventListener("click", () => {
                modal.hide();
            });
        }

        async function loadDashboardData() {
            showLoading(true);

            try {
                const dateRange = document.getElementById('dateRangeFilter').value;
                const response = await fetch(`@Url.Action("GetDashboardData", "Dashboard")?months=${dateRange}`);
                const data = await response.json();

                if (data.success) {
                    updateDashboard(data);
                    currentDateRange = data.dateRange || 6;
                    updateDateRangeDisplay();
                } else {
                    showError('Failed to load dashboard data');
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                useSampleData();
            } finally {
                showLoading(false);
            }
        }

        function updateDateRangeDisplay() {
            const displayElement = document.getElementById('dateRangeDisplay');
            const filterValue = document.getElementById('dateRangeFilter').value;

            const rangeTexts = {
                '6': 'Showing last 6 months',
                '3': 'Showing last 3 months',
                '12': 'Showing last 12 months',
                '1': 'Showing last 30 days',
                '0': 'Showing all time data'
            };

            displayElement.textContent = rangeTexts[filterValue] || 'Showing data';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize modal if needed
            const showModal = @(ViewBag.ShowSyncModal?.ToString().ToLower() ?? "false");
            if (showModal === true) {
                initializeSyncModal();
            }

            // Load dashboard data
            loadDashboardData();

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadDashboardData);

            // Add date range filter change listener
            document.getElementById('dateRangeFilter').addEventListener('change', function() {
                loadDashboardData();
            });
        });

        function updateDashboard(data) {
            // Update statistics cards with dynamic data
            document.getElementById('totalCases').textContent = data.totalCases || '0';
            document.getElementById('totalImports').textContent = data.totalImports || '0';
            document.getElementById('totalAnomalies').textContent = data.totalAnomalies || '0';

            // Update last updated time
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

            // Update charts
            updateCharts(data.charts);
        }

        function updateCharts(chartData) {
            // Acquisition Pie Chart
            if (acquisitionPieChart) acquisitionPieChart.destroy();
            const pieCanvas = document.getElementById('acquisitionPieChart');
            if (pieCanvas) {
                const pieLabels = chartData?.acquisitionTypes?.labels || ['Memory Capture', 'Drive image/Clone', 'Snapshots'];
                const pieData = chartData?.acquisitionTypes?.data || [45, 30, 15];

                acquisitionPieChart = new Chart(pieCanvas, {
                    type: 'pie',
                    data: {
                        labels: pieLabels,
                        datasets: [{
                            data: pieData,
                            backgroundColor: [
                                '#3b82f6', // Blue for Memory Capture
                                '#10b981', // Green for Drive image/Clone
                                '#f59e0b', // Yellow for Snapshots
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Activity Line Chart
            if (activityLineChart) activityLineChart.destroy();
            const lineCanvas = document.getElementById('activityLineChart');
            if (lineCanvas) {
                activityLineChart = new Chart(lineCanvas, {
                    type: 'line',
                    data: {
                        labels: chartData?.activityTimeline?.labels || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [
                            {
                                label: 'Cases',
                                data: chartData?.activityTimeline?.cases || [12, 19, 8, 15, 22, 18],
                                borderColor: '#0c3b66',
                                backgroundColor: 'rgba(12, 59, 102, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Acquisitions',
                                data: chartData?.activityTimeline?.acquisitions || [8, 12, 6, 10, 15, 20],
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Count'
                                }
                            }
                        }
                    }
                });
            }
        }

        function useSampleData() {
            // Sample data for demo purposes
            const sampleData = {
                success: true,
                totalCases: 24,
                totalImports: 156,
                totalAnomalies: 12,
                charts: {
                    acquisitionTypes: {
                        labels: ['Memory Capture', 'Drive image/Clone', 'Snapshots'],
                        data: [67, 42, 28]
                    },
                    activityTimeline: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        cases: [8, 12, 6, 15, 18, 24],
                        acquisitions: [15, 22, 18, 25, 30, 42]
                    }
                }
            };
            updateDashboard(sampleData);
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('dashboardContent').style.display = show ? 'none' : 'block';
        }

        function showError(message) {
            alert(message);
        }
    </script>

    <style>
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

            .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }

        .display-6 {
            font-size: 2rem;
            font-weight: 300;
        }

        .btn-outline-primary, .btn-outline-success,
        .btn-outline-warning, .btn-outline-info {
            transition: all 0.2s ease-in-out;
        }

            .btn-outline-primary:hover, .btn-outline-success:hover,
            .btn-outline-warning:hover, .btn-outline-info:hover {
                transform: translateX(5px);
            }
    </style>
}